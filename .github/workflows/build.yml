# PowerGrid — build server (Gradle) and client (Godot 4.4)
# Mirrors behavior described in CLAUDE.md and .gitlab-ci.yml

name: Build

on:
  push:
    branches: [main, master]
    paths:
      - 'server/**'
      - 'client/**'
      - '.github/**'
  pull_request:
    branches: [main, master]
    paths:
      - 'server/**'
      - 'client/**'
      - '.github/**'

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle-home

jobs:
  # ─── Server ─────────────────────────────────────────────────────────────
  server-validate:
    name: Server · Validate wrapper
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            .gradle-home/caches
            .gradle-home/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('server/gradle/wrapper/gradle-wrapper.properties', 'server/build.gradle.kts') }}

      - name: Validate Gradle wrapper
        run: ./gradlew validateWrapper

  server-build:
    name: Server · Build
    runs-on: ubuntu-latest
    needs: server-validate
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            .gradle-home/caches
            .gradle-home/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('server/gradle/wrapper/gradle-wrapper.properties', 'server/build.gradle.kts') }}

      - name: Compile
        run: ./gradlew classes

  server-test:
    name: Server · Test
    runs-on: ubuntu-latest
    needs: server-build
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            .gradle-home/caches
            .gradle-home/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('server/gradle/wrapper/gradle-wrapper.properties', 'server/build.gradle.kts') }}

      - name: Run tests
        run: ./gradlew test

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: build/test-results/test/TEST-*.xml
          check_name: Server test results

  server-package:
    name: Server · Package JAR
    runs-on: ubuntu-latest
    needs: server-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    defaults:
      run:
        working-directory: server
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            .gradle-home/caches
            .gradle-home/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('server/gradle/wrapper/gradle-wrapper.properties', 'server/build.gradle.kts') }}

      - name: Build shadow JAR
        run: ./gradlew shadowJar

      - name: Upload server JAR
        uses: actions/upload-artifact@v4
        with:
          name: powergrid-server-${{ github.sha }}
          path: server/build/libs/powergrid-server.jar

  # ─── Client ─────────────────────────────────────────────────────────────
  client-export-linux:
    name: Client · Export Linux
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    container:
      image: barichello/godot-ci:4.4
    steps:
      - uses: actions/checkout@v4

      - name: Export Linux
        run: |
          mkdir -p client/dist/linux
          cd client && godot --headless --export-release "Linux/X11" dist/linux/PowerGrid.x86_64

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: powergrid-linux-${{ github.sha }}
          path: client/dist/linux/

  client-export-windows:
    name: Client · Export Windows
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    container:
      image: barichello/godot-ci:4.4
    steps:
      - uses: actions/checkout@v4

      - name: Export Windows
        run: |
          mkdir -p client/dist/windows
          cd client && godot --headless --export-release "Windows Desktop" dist/windows/PowerGrid.exe

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: powergrid-windows-${{ github.sha }}
          path: client/dist/windows/

  client-export-macos:
    name: Client · Export macOS
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    container:
      image: barichello/godot-ci:4.4
    steps:
      - uses: actions/checkout@v4

      - name: Export macOS
        run: |
          mkdir -p client/dist/macos
          cd client && godot --headless --export-release "macOS" dist/macos/PowerGrid.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: powergrid-macos-${{ github.sha }}
          path: client/dist/macos/
